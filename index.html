<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forklift Simulator</title>
    <style>
        body { margin: 0; overflow: hidden; background: #333; }
        #ui {
            position: absolute; top: 20px; width: 100%; text-align: center;
            color: white; font-family: monospace; font-size: 20px;
            pointer-events: none; text-shadow: 2px 2px 0 #000;
        }
    </style>
</head>
<body>
    <div id="ui">
        Wait for models to load...<br>
        Arrows to Drive | SPACE to Lift
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GAME STATE (Prep for Multiplayer) ---
        // We store data here. Later, we can send this "player" object 
        // to a server so other people see you move.
        const player = {
            x: 0,
            z: 0,
            angle: 0,
            speed: 0,
            isLifting: false
        };

        // --- 1. SETUP SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky blue
        scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(10, 20, 10);
        sun.castShadow = true;
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404040));

        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(200, 200),
            new THREE.MeshStandardMaterial({ color: 0x555555 })
        );
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Grid
        scene.add(new THREE.GridHelper(200, 50));

        // --- 2. ASSET LOADING ---
        const models = { forklift: null, pallet: null };
        const loadingMgr = new THREE.LoadingManager(() => {
            document.getElementById('ui').innerHTML = "WASD / ARROWS to Drive | SPACE to Lift";
        });

        // Load Forklift (OBJ)
        new OBJLoader(loadingMgr).load('Forklift.obj', (obj) => {
            models.forklift = obj;
            // Make it yellow and industrial
            obj.traverse(child => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({ color: 0xffaa00, roughness: 0.6 });
                    child.castShadow = true;
                }
            });
            obj.scale.set(0.015, 0.015, 0.015); // Scale fix
            scene.add(obj);
        });

        // Load Pallet (GLB)
        new GLTFLoader(loadingMgr).load('Pallet.glb', (gltf) => {
            models.pallet = gltf.scene;
            models.pallet.position.set(5, 0, 5);
            models.pallet.scale.set(1.5, 1.5, 1.5);
            models.pallet.traverse(c => { if(c.isMesh) c.castShadow = true; });
            scene.add(models.pallet);
        });

        // --- 3. INPUTS ---
        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => {
            keys[e.code] = false;
            if (e.code === 'Space') attemptLift();
        });

        function attemptLift() {
            if (!models.forklift || !models.pallet) return;
            
            if (player.isLifting) {
                // DROP
                models.pallet.removeFromParent(); // Detach from forklift
                scene.add(models.pallet); // Re-add to world
                
                // Set position to where the forklift is + slight offset
                models.pallet.position.copy(models.forklift.position);
                models.pallet.translateZ(2); // Drop slightly in front
                models.pallet.position.y = 0; // On floor
                models.pallet.rotation.set(0, player.angle, 0);
                
                player.isLifting = false;
            } else {
                // PICK UP
                const dist = models.forklift.position.distanceTo(models.pallet.position);
                if (dist < 4) { // If close enough
                    models.forklift.add(models.pallet);
                    models.pallet.position.set(0, 100, 150); // Relative to forklift (up and forward)
                    models.pallet.rotation.set(0, 0, 0);
                    player.isLifting = true;
                }
            }
        }

        // --- 4. GAME LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (models.forklift) {
                // Physics Logic
                if (keys['ArrowUp'] || keys['KeyW']) player.speed += 0.01;
                else if (keys['ArrowDown'] || keys['KeyS']) player.speed -= 0.01;
                else player.speed *= 0.95; // Friction

                // Cap speed
                player.speed = Math.max(Math.min(player.speed, 0.3), -0.2);

                if (Math.abs(player.speed) > 0.01) {
                    if (keys['ArrowLeft'] || keys['KeyA']) player.angle += 0.04;
                    if (keys['ArrowRight'] || keys['KeyD']) player.angle -= 0.04;
                }

                // Update Visuals based on Data
                player.x += Math.sin(player.angle) * player.speed;
                player.z += Math.cos(player.angle) * player.speed;

                models.forklift.position.set(player.x, 0, player.z);
                models.forklift.rotation.y = player.angle;

                // Camera Follow
                const camOffset = new THREE.Vector3(0, 8, -12); // Behind and up
                camOffset.applyAxisAngle(new THREE.Vector3(0, 1, 0), player.angle);
                camera.position.lerp(models.forklift.position.clone().add(camOffset), 0.1);
                camera.lookAt(models.forklift.position);
            }

            renderer.render(scene, camera);
        }

        animate();
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
